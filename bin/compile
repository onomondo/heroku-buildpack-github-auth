#!/usr/bin/env bash

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3
CONFIG_PATH=$HOME/.gitconfig
ASKPASS_PATH=$HOME/.git-askpass

if [ ! -f $ENV_DIR/GITHUB_AUTH_TOKEN ]; then
  echo "GITHUB_AUTH_TOKEN environment variable not set"
  exit 1
fi

TOKEN=`cat $ENV_DIR/GITHUB_AUTH_TOKEN`

cat >$CONFIG_PATH <<EOL
[core]
    askpass = ~/.git-askpass
[url "https://api.github.com/"]
    insteadOf = "https://github.com/"
[url "https://ssh@github.com/"]
    insteadOf = "ssh://git@github.com/"
[url "https://git@github.com/"]
    insteadOf = "git@github.com:"
EOL

cat >$ASKPASS_PATH <<EOL
echo $TOKEN
EOL

chmod +x $ASKPASS_PATH

echo "export GIT_ASKPASS=\"$HOME/.git-askpass\"" >> $BUILD_DIR/export
